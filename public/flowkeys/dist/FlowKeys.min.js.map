{
  "version": 3,
  "sources": ["../src/FlowKeys.ts"],
  "sourcesContent": ["type Key = KeyboardEvent[\"key\"];\ntype CommandCallback = () => void;\ntype KeyCombo = Set<Key>;\n\ninterface TrieNode {\n\tchildren: Map<string, TrieNode>;\n\tcallback?: CommandCallback;\n\toptions?: { once?: boolean; stopOthers?: boolean };\n}\n\nexport class FlowKeys {\n\tprivate root: TrieNode = { children: new Map() };\n\tprivate buffer: KeyCombo[] = [];\n\tprivate maxSequenceLength = 0;\n\tprivate pressedKeys: Set<Key> = new Set();\n\tprivate isLastKeyDown: boolean = false;\n\tprivate aliasMap: Map<Key, Key[]> = new Map();\n\tprivate target: HTMLElement | Document | Window;\n\n\t// 標準化マップ（OS/ブラウザ差異の吸収）\n\tprivate static STANDARD_KEY_MAP: Record<Key, Key> = {\n\t\tesc: \"escape\",\n\t\tdel: \"delete\",\n\t\treturn: \"enter\",\n\t\tleft: \"arrowleft\",\n\t\tright: \"arrowright\",\n\t\tup: \"arrowup\",\n\t\tdown: \"arrowdown\",\n\t\t\" \": \"space\",\n\t\tctrl: \"control\",\n\t\tcmd: \"meta\",\n\t\twindows: \"meta\",\n\t};\n\n\tconstructor(target?: HTMLElement | Document | Window) {\n\t\tthis.target = (target ?? window) as Window;\n\t\tthis.handleKeyDown = this.handleKeyDown.bind(this);\n\t\tthis.handleKeyUp = this.handleKeyUp.bind(this);\n\t\tthis.target.addEventListener(\"keydown\", this.handleKeyDown, true);\n\t\tthis.target.addEventListener(\"keyup\", this.handleKeyUp, true);\n\t}\n\n\t// 代替キー登録\n\tpublic addAlias(key: Key, aliases: Key[]) {\n\t\tthis.aliasMap.set(\n\t\t\tkey.toLowerCase(),\n\t\t\taliases.map((k) => k.toLowerCase())\n\t\t);\n\t}\n\n\t// シーケンス登録\n\tpublic register(sequence: (Key | Key[])[], callback: CommandCallback, options?: { once?: boolean; stopOthers?: boolean }) {\n\t\tif (!sequence.length) return;\n\t\tthis.maxSequenceLength = Math.max(this.maxSequenceLength, sequence.length);\n\n\t\tlet node = this.root;\n\t\tfor (const item of sequence) {\n\t\t\tconst combo = new Set(Array.isArray(item) ? item : [item]);\n\t\t\tconst key = FlowKeys.setToKey(this.normalizeCombo(combo));\n\t\t\tif (!node.children.has(key)) node.children.set(key, { children: new Map() });\n\t\t\tnode = node.children.get(key)!;\n\t\t}\n\t\tnode.callback = callback;\n\t\tnode.options = options;\n\t}\n\n\tpublic unregister(sequence: (Key | Key[])[]) {\n\t\tif (!sequence.length) return;\n\n\t\tconst path: TrieNode[] = [];\n\t\tlet node: TrieNode | undefined = this.root;\n\n\t\tfor (const item of sequence) {\n\t\t\tconst combo = new Set(Array.isArray(item) ? item : [item]);\n\t\t\tconst key = FlowKeys.setToKey(this.normalizeCombo(combo));\n\t\t\tif (!node.children.has(key)) return; // 登録なし\n\t\t\tnode = node.children.get(key)!;\n\t\t\tpath.push(node);\n\t\t}\n\n\t\t// コールバックを削除\n\t\tif (node) {\n\t\t\tnode.callback = undefined;\n\t\t\tnode.options = undefined;\n\t\t}\n\t\tfor (let i = path.length - 1; i >= 0; i--) {\n\t\t\tconst parent = i > 0 ? path[i - 1] : this.root;\n\t\t\tconst key = Array.from(path[i].children.keys())[0]; // children が空なら削除\n\t\t\tif (path[i].callback === undefined && path[i].children.size === 0) {\n\t\t\t\tparent.children.delete(key);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate normalizeCombo(combo: KeyCombo): KeyCombo {\n\t\tconst normalized = new Set<Key>();\n\t\tfor (let k of combo) {\n\t\t\tk = (FlowKeys.STANDARD_KEY_MAP[k] ?? k).toLowerCase();\n\n\t\t\tlet mapped = false;\n\t\t\tfor (const [key, aliases] of this.aliasMap) {\n\t\t\t\tif (aliases.includes(k)) {\n\t\t\t\t\tnormalized.add(key);\n\t\t\t\t\tmapped = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!mapped) normalized.add(k);\n\t\t}\n\t\treturn normalized;\n\t}\n\n\tprivate static setToKey(combo: KeyCombo) {\n\t\treturn Array.from(combo).sort().join(\"+\");\n\t}\n\n\tprivate handleKeyDown(event: KeyboardEvent) {\n\t\tconst key = (FlowKeys.STANDARD_KEY_MAP[event.key] ?? event.key).toLowerCase();\n\t\tif (this.pressedKeys.has(key)) return;\n\t\tthis.pressedKeys.add(key);\n\t\tthis.isLastKeyDown = true;\n\t}\n\n\tprivate handleKeyUp(event: KeyboardEvent) {\n\t\tconst key = (FlowKeys.STANDARD_KEY_MAP[event.key] ?? event.key).toLowerCase();\n\t\tif (this.pressedKeys.has(key) && this.isLastKeyDown) {\n\t\t\tthis.isLastKeyDown = false;\n\n\t\t\tconst comboCopy = new Set(this.pressedKeys);\n\t\t\tthis.buffer.push(this.normalizeCombo(comboCopy));\n\t\t\tif (this.buffer.length > this.maxSequenceLength) this.buffer.shift();\n\n\t\t\tthis.checkBuffer();\n\t\t}\n\n\t\tthis.pressedKeys.delete(key);\n\t}\n\n\tprivate checkBuffer() {\n\t\tif (!this.buffer.length) return;\n\n\t\tconst stopFlags: boolean[] = [];\n\t\tfor (let start = 0; start < this.buffer.length; start++) {\n\t\t\tif (stopFlags[start]) continue;\n\t\t\tlet node: TrieNode = this.root;\n\t\t\tlet matched = true;\n\t\t\tfor (let i = start; i < this.buffer.length; i++) {\n\t\t\t\tconst keyStr = FlowKeys.setToKey(this.buffer[i]);\n\t\t\t\tif (!node.children.has(keyStr)) {\n\t\t\t\t\tmatched = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tnode = node.children.get(keyStr)!;\n\t\t\t}\n\t\t\tif (matched && node.callback) {\n\t\t\t\tnode.callback();\n\t\t\t\tif (node.options?.once) {\n\t\t\t\t\tnode.callback = undefined;\n\t\t\t\t\tnode.options = undefined;\n\t\t\t\t}\n\t\t\t\tif (node.options?.stopOthers) {\n\t\t\t\t\tfor (let j = start + 1; j < this.buffer.length; j++) stopFlags[j] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic destroy() {\n\t\t(this.target as Window).removeEventListener(\"keydown\", this.handleKeyDown, true);\n\t\t(this.target as Window).removeEventListener(\"keyup\", this.handleKeyUp, true);\n\t\tthis.buffer = [];\n\t\tthis.root = { children: new Map() };\n\t\tthis.pressedKeys.clear();\n\t\tthis.isLastKeyDown = false;\n\t\tthis.aliasMap.clear();\n\t\tthis.maxSequenceLength = 0;\n\t}\n}\n\nif (typeof window !== \"undefined\") {\n\t(window as any).FlowKeys = FlowKeys;\n}\n"],
  "mappings": "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",
  "names": ["FlowKeys", "_FlowKeys", "target", "key", "aliases", "k", "sequence", "callback", "options", "node", "item", "combo", "path", "i", "parent", "normalized", "mapped", "event", "comboCopy", "stopFlags", "start", "matched", "keyStr", "j"]
}
